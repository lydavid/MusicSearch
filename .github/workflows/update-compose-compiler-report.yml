name: Update compose compiler report

on:
  schedule:
    - cron: '42 6 * * 5'
  workflow_dispatch:

jobs:
  update-compose-compiler-report:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      ORG_GRADLE_PROJECT_MUSICBRAINZ_CLIENT_ID: ${{ secrets.ORG_GRADLE_PROJECT_MUSICBRAINZ_CLIENT_ID }}
      ORG_GRADLE_PROJECT_MUSICBRAINZ_CLIENT_SECRET: ${{ secrets.ORG_GRADLE_PROJECT_MUSICBRAINZ_CLIENT_SECRET }}
      ORG_GRADLE_PROJECT_SPOTIFY_CLIENT_ID: ${{ secrets.ORG_GRADLE_PROJECT_SPOTIFY_CLIENT_ID }}
      ORG_GRADLE_PROJECT_SPOTIFY_CLIENT_SECRET: ${{ secrets.ORG_GRADLE_PROJECT_SPOTIFY_CLIENT_SECRET }}
    steps:
      - name: Checkout
        uses: nschloe/action-cached-lfs-checkout@f46300cd8952454b9f0a21a3d133d4bd5684cfc2 # v1
        with:
          token: ${{ secrets.PAT }}

      - name: Setup gradle
        uses: ./.github/actions/setup

      - name: Setup Node.js
        uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm install -g compose-report2html

      - name: Write to keystore.properties
        run: |
          echo "storePassword=${{ secrets.RELEASE_STORE_PASSWORD }}" >> keystore.properties
          echo "keyPassword=${{ secrets.RELEASE_KEY_PASSWORD }}" >> keystore.properties
        shell: bash

      # Necessary because the debug and release version of the app has a different redirect
      - name: Replace debug MusicBrainz client id/secret with release versions
        run: |
          echo "TVVTSUNCUkFJTlpfQ0xJRU5UX0lEPWtpbVpiWXlaYUVia2Ewb0Npb1ExNUdINWhlNFp4dGtXCg==" | base64 -d > not_so_secret.properties
          echo "TVVTSUNCUkFJTlpfQ0xJRU5UX1NFQ1JFVD00ZVlINmpqRzBVVm1GRGN1Yk1CSThrVVlxT18xVkxHRAo=" | base64 -d >> not_so_secret.properties

      - name: Convert base64 to files
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 -d > android/app/google-services.json
          echo "${{ secrets.RELEASE_KEYSTORE_JKS_BASE64 }}" | base64 -d > release-keystore.jks
        shell: bash

      - name: Assemble apk with compose compiler reports enabled
        run: ./gradlew assembleFDroidRelease -Pmusicsearch.enableComposeCompilerReports=true --rerun-tasks

      - name: Generate HTML from compose reports
        run: find . -type d -path '*/build/compose_metrics' | xargs -I {} composeReport2Html -app MusicSearch -i {} -o {}

      - name: Move the compose reports and HTML file to each module's root
        run: find . -type d -path '*/build/compose_metrics' -exec bash -c 'mv {}/* "$(dirname "$(dirname {})")"' \;

      - run: git pull --rebase --autostash

      - name: Commit version code bump
        uses: stefanzweifel/git-auto-commit-action@e348103e9026cc0eee72ae06630dbe30c8bf7a79 # v5.1.0
        with:
          commit_message: 'chore: update compose compiler report [skip ci]'
          commit_author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          file_pattern: '**/*classes.txt **/*composables.csv **/*composables.txt **/*module.json'
